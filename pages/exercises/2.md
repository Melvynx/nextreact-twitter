# React-query

C'est parti pour refactor le code de l'exercice pr√©c√©dent avec React Query.
Pour faire cet exercice, il faut que tu aies regard√© le cours num√©ro sur React Query.
Tu retrouveras **toutes** les informations sur la plateforme de formation.

Je tiens √† dire que j'ai d√©plac√© `client` et le `TweetsScheme` dans des fichiers s√©par√©s
afin que tu puisses te concentrer sur l'exercice et que tu n'aies pas trop de code dans
le fichier.

Voici le lien des documentations utiles :

- [üìñ tanstack query](https://tanstack.com/query/v4)
- [üìñ use-query](https://tanstack.com/query/v4/docs/react/reference/useQuery)

## Part 1 : Utiliser useQuery

Dans le dernier exercice, on a d√©j√† d√©plac√© le fetch dans une fonction `getTweets`.
Maintenant, utilisons `useQuery` pour faire le fetch avec comme key `tweets`.

Ajoute un spinner durant le loading et un message d'erreur s'il y a une erreur.

Tu peux utiliser les variables que retourne le hook `useQuery` pour afficher le spinner
et le message d'erreur.

Tu retrouveras le composant Loader dans le dossier `src/components/Loader.tsx`[src/components/Loader.tsx]

## Part 2 : Ajout d'un nouveau tweet

Dans le rendu de notre composant, il y a [`AddTweetForm`](src/components/tweets/AddTweetForm.tsx).

Je te conseille d'aller lire son code pendant 2 minutes et bien comprendre comment il fonctionne.

(PS : Oui, je d√©conseille d'utiliser des states pour g√©rer les formulaires, mais c'est pour que le textarea grandisse tout seul !)

Pour l'instant, ce `AddTweetForm` ne fait **rien**, il a juste une props `onSubmit` qui est
un callback qui est appel√© quand on submit le formulaire.

J'aimerais bien que tu cr√©es un composant `AddTweet` qui va contenir ce `AddTweetForm`
et qui va g√©rer l'ajout d'un tweet. Pour ajouter un tweet, tu vas pouvoir utiliser
notre fonction `client` afin de fetch l'url `/api/tweets` avec la m√©thode `POST`.

Cette endpoint attend comme body :

```ts
const AddTweetBody = z.object({
  content: z.string(),
});
```

Cette endpoint va retourner un tweet. Pour garder synchronis√©e notre liste de tweet, il va
falloir que tu [invalides la query](https://tanstack.com/query/v4/docs/react/guides/query-invalidation) `tweets` afin pour
provoquer un nouveau fetch.

Pour en savoir plus :

- [üìñ invalidation](https://tanstack.com/query/v4/docs/react/guides/query-invalidation)

En plus de √ßa, pour performer cette action on va utiliser une `mutation` de React Query.
Pour en savoir plus :

- [üìñ mutation](https://tanstack.com/query/v4/docs/react/guides/mutations)

Tu vas voir avec cette exemple la magie de tanstack query.

(Tu peux retourner sur mes cours pour comprendre l'invalidation des query et la mutation)

## Part 3 : Infinite scroll

C'est un peu dommage, car pour l'instant on n'affiche que 10 tweets. Or tanstack-query poss√®de
un outil pour faire de l'infinite scroll. On appelle √ßa des [infinite query](https://tanstack.com/query/v4/docs/react/guides/infinite-queries).

Je te conseille d'aller jeter un ≈ìil √† la documentation puisque je n'ai pas d√©taill√© les infinite query dans mon cours.

Pour √ßa il va falloir modifier un peu notre code.

1. Changer `getTweets` pour qu'elle prenne en param√®tre une `page` en param√®tre
   - utiliser cette url pour query `/api/tweets?page=${page}`
2. Remplacer `useQuery` avec `useInfiniteQuery`
   - rajouter le param√®tre : `getNextPageParam: (lastPage) => lastPage.nextPage,` (PS : j'ai d√©j√† rajout√© `nextPage` dans le sch√©ma zod)
   - r√©cup√©rer les valeurs retours suivantes : `data, isLoading, isError, isFetchingNextPage, hasNextPage, fetchNextPage`
3. Modifier la r√©cup√©ration des tweets
   - `const tweets = data.pages.flatMap((page) => page.tweets);`
4. Ajouter un bouton pour fetch les tweets suivants

```tsx
const nextPageStatus = hasNextPage ? 'hasNextPage' : 'noNextPage';

<button onClick={() => fetchNextPage()} className="block py-4">
  {isFetchingNextPage ? 'Loading more...' : nextPageStatus}
</button>;
```

Normalement avec ces informations, tu vas pouvoir te d√©brouiller pour faire l'infinite scroll.

#### Quelques d√©tails

D√®s lors que tu fais ce genre de chose, il devient plus compliqu√© de muter la bonne valeur comme
tu le verras dans l'exercice 4, mais c'est possible.

- [refetchPage](https://tanstack.com/query/v4/docs/react/guides/infinite-queries#refetchpage)

Je ne vais pas rentrer dans **chaque** d√©tail de tanstack-query, mais je te conseille de
regarder la documentation pour en savoir plus et surtout aller plus loin dans ce projet.

Exemple :

- Ajouter l'infinite scroll dans le prochain exercice des mutations
- Ajouter la possibilit√© de supprimer son propre Tweet

Enfin, tu peux aller tr√®s loin avec tanstack-query.

#### Bonus

Trouve un moyen pour faire un `refetch on scroll` (comme sur Twitter) !

Quand on arrive en bas de la page, on fetch les tweets suivants... ainsi de suite !

Pas de vid√©o solution pour ce bonus, mais tu trouveras la solution dans [2-3-bonus.tsx]

### Part 4 : Refactor

Le probl√®me de `useQuery` c'est que tout se fait avec des strings et des keys, il est facile
de faire des erreurs et d'utiliser la mauvaise cl√©.

Une bonne pratique, c'est de d√©placer les appels √† useQuery dans des hooks custom.

Et c'est justement ce que je vais te demander de faire dans cette partie 4. Ton objectif
et de refactor notre code dans un custom hooks !

Tu peux aussi stocker la cl√© `TWEET_KEY` dans une variable afin de pouvoir l'utiliser
2 fois sans avoir √† la r√©√©crire.

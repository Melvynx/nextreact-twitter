# React-query

C'est partie pour refactor le code de l'exercice pr√©c√©dent avec React Query.
Pour faire cette exercice, il faut que tu ai regard√© le cours num√©ro 7 et 8.
Tu retrouveras **toutes** les informations sur la plateforme de formation.

Je tiens √† dire que j'ai d√©placer `client` et le tweeter scheme dans des fichiers s√©parer
afin que tu puisses te concentrer sur l'exercice et que tu n'ai pas trop de code dans
le fichier.

Voici le liens des documentations utiles :
[üìñ tanstack query](https://tanstack.com/query/v4)
[üìñ use-query](https://tanstack.com/query/v4/docs/react/reference/useQuery)

## Part 1 : Utiliser useQuery

Dans le derni√®re exercice on √† d√©j√† d√©placer le fetch dans une fonction `getTweets`.
Maintenant utilisons `useQuery` pour faire le fetch avec comme key `tweets`.

Ajoute un spinner durant le loading et un message d'erreur si il y a une erreur.

Tu retrouveras le composant Loader dans le dossier `src/components/Loader.tsx`.

## Part 2 : Ajout d'un nouveau tweet

Dans le rendu de notre composant il y a `AddTweetForm`.

J'aimerais bien que tu cr√©er un composant `AddTweet` qui va contenir ce `AddTweetForm`
et qui va g√©rer l'ajout d'un tweet. Pour ajouter un tweet tu vas pouvoir utiliser
notre fonction `client` afin de fetch l'url `/api/tweets` avec la m√©thode `POST`.

Cette endpoint attend comme body :

```ts
const AddTweetBody = z.object({
  text: z.string(),
  userId: z.string(),
});
```

Tu peux r√©cup√©rer le userId avec le hooks `useUser` qui retourne `user` si il existe.

Cette endpoint va retourn√© un tweet. Pour garder synchroniser notre liste de tweet il va
falloir que tu [invalides la query](https://tanstack.com/query/v4/docs/react/guides/query-invalidation) `tweets` afin de la refetch.

Pour en savoir plus :

- [üìñ invalidation](https://tanstack.com/query/v4/docs/react/guides/query-invalidation)

En plus de √ßa, pour performer cette action on va utiliser une `mutation` de React Query.
Pour en savoir plus :

- [üìñ mutation](https://tanstack.com/query/v4/docs/react/guides/mutations)

Tu vas voir avec cette exemple la magie de tanstack query.

## Part 3 : Infinite scroll

C'est un peu dommage car pour l'instant on affiche que 10 tweet. Or tanstack-query poss√®de
un outil pour faire de l'infinite scroll. On appel √ßa des [infinite query](https://tanstack.com/query/v4/docs/react/guides/infinite-queries).

Je te conseil d'aller jeter un ceil √† la documentation car je n'ai pas d√©taill√© les infinite query dans mon cours.

Pour √ßa il va falloir modifier un peu notre code.

1. Changer `getTweets` pour qu'elle prenne en param√®tre un `page` en param√®tre
   - utiliser cette url pour query `/api/tweets?page=${page}`
2. Remplacer `useQuery` avec `useInfiniteQuery`
   - rajouter le param√®tre : `getNextPageParam: (lastPage) => lastPage.nextPage,` (PS : j'ai d√©j√† rajouter `nextPage` dans le sch√©ma zod)
   - r√©cup√©rer les valeurs retours suivantes : `data, isLoading, isError, isFetchingNextPage, hasNextPage, fetchNextPage`
3. Modifier la r√©cup√©ration des tweets
   - `const tweets = data.pages.flatMap((page) => page.tweets);`
4. Ajouter un bouton pour fetch les tweets suivants

```tsx
const nextPageStatus = hasNextPage ? 'hasNextPage' : 'noNextPage';

<button onClick={() => fetchNextPage()} className="block py-4">
  {isFetchingNextPage ? 'Loading more...' : nextPageStatus}
</button>;
```

Normalement avec ses information tu vas pouvoir te d√©brouiller pour faire l'infinite scroll.

#### Quelques d√©tails

D√®s lors que tu fais ce genre de chose, il devient plus compliqu√© de mut√© la bonne valeur comme
tu le verras dans l'exercices 4, mais c'est possible.

- [refetchPage](https://tanstack.com/query/v4/docs/react/guides/infinite-queries#refetchpage)

Je ne vais pas rentrer dans **chaque** d√©tails de tanstack-query, mais je te conseille de
regarder la documentation pour en savoir plus et surtout d'aller plus loins pour ce projet.

Exemple :

- Ajouter l'infinite scroll dans le prochain exercice des mutations
- Ajouter la possibilit√© de supprimer son propre Tweet

Enfin tu peux aller tr√®s loins avec tanstack-query.

### Part 4 : Refactor

Le probl√®me de `useQuery` c'est que tout se fait avec des string et des key, il est facile
de faire des erreurs et d'utiliser la mauvaise cl√©.

Une bonne pratique c'est de d√©placer les appels √† useQuery dans des hooks custom.

Et c'est justement ce que je vais te demander de faire dans cette partie 4. Ton objectif
et de refactor notre code dans un custom hooks !
